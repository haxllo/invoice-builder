import { useCallback, useEffect, useRef } from 'react';
import { useAppDispatch } from '@/lib/store/configureStore';
import { addToast, disableLoadingCursor, enableLoadingCursor } from '@/lib/store/pageSlice';
import { useAsync } from './useAsync';

interface UseAsyncActionOptions<T> {
  showLoader?: boolean;
  immediate?: boolean;
  onDone?: (data: T) => void;
}

export const useAsyncAction = <T>(
  asyncFn: () => Promise<T>,
  { showLoader = true, immediate = true, onDone }: UseAsyncActionOptions<T> = {}
) => {
  const dispatch = useAppDispatch();
  const onDoneRef = useRef(onDone);

  useEffect(() => {
    onDoneRef.current = onDone;
  }, [onDone]);

  const handleLoadingChange = useCallback(
    (isLoading: boolean) => {
      if (!showLoader) return;
      if (isLoading) dispatch(enableLoadingCursor());
      else dispatch(disableLoadingCursor());
    },
    [dispatch, showLoader]
  );

  const handleError = useCallback(
    (err: Error) => {
      dispatch(addToast({ message: err.message, severity: 'error' }));
    },
    [dispatch]
  );

  const { data, loading, execute } = useAsync<T>(asyncFn, {
    onLoadingChange: handleLoadingChange,
    onError: handleError,
    immediate
  });

  useEffect(() => {
    if (!loading && data !== null) {
      onDoneRef.current?.(data);
    }
  }, [loading, data]);

  return { data, loading, execute };
};
